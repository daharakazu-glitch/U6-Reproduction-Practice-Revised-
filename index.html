<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproduction Practice App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            font-weight: bold;
        }
        .keyword-tag {
            background-color: #f0f9ff;
            color: #0c4a6e;
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 1.1rem;
            margin: 5px;
            display: inline-block;
            border: 1px solid #bae6fd;
        }
        .used-keyword {
            background-color: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }
        #transcript-container {
            max-height: 150px;
            overflow-y: auto;
        }
        .mode-btn-active {
            background-color: #0284c7 !important;
            color: white !important;
        }
         .mode-btn-inactive {
            background-color: #e2e8f0;
            color: #334155;
        }
        
        /* Styles for the new zoom effect */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(22, 29, 44, 0.75); /* Dark slate overlay */
            z-index: 40;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Prevent interaction when hidden */
        }
        #overlay.show {
            opacity: 1;
        }

        #keywords-section.zoomed {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 90vw;
            max-width: 900px; /* Limit max width on large screens */
            max-height: 90vh;
            transform: translate(-50%, -50%);
            z-index: 50;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }

        /* Styles for the floating recording controls */
        #recording-controls.active {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            
            /* Horizontal layout */
            flex-direction: row;
            gap: 1.5rem;
            align-items: center;
            width: auto;
        }

        #recording-controls.active #timer {
            font-size: 2.25rem; /* A bit smaller for the bar */
            margin: 0;
        }
        
        #recording-controls.active #record-btn {
            width: auto;
            padding: 0.75rem 2rem;
            font-size: 1.125rem;
            margin: 0;
        }

    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="overlay"></div>

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 relative">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-slate-900">Reproduction Practice</h1>
            <p class="text-slate-500 mt-2 text-lg">Topic: Nelson Mandela</p>
        </header>

        <!-- Mode Selection -->
        <div id="mode-selection" class="flex justify-center gap-4 mb-4">
            <button id="mode-full" class="px-6 py-3 font-bold rounded-full transition-colors duration-300">Full Text Mode</button>
            <button id="mode-paragraph" class="px-6 py-3 font-bold rounded-full transition-colors duration-300">Paragraph Mode</button>
        </div>

        <!-- Paragraph Selection -->
        <div id="paragraph-selection" class="hidden justify-center gap-2 mb-6 flex-wrap">
            <!-- Paragraph buttons will be generated here -->
        </div>

        <!-- Time Limit Setting -->
        <div id="time-setting-container" class="flex justify-center items-center gap-4 mb-6">
            <label for="time-slider" class="text-lg font-bold text-slate-600">Time Limit:</label>
            <input type="range" id="time-slider" min="30" max="300" step="15" class="w-48 cursor-pointer">
            <span id="time-display" class="text-lg font-bold text-sky-600 w-16 text-center">2:00</span>
        </div>


        <div class="grid md:grid-cols-2 gap-8">
            <!-- Keywords Section -->
            <div id="keywords-section" class="bg-slate-100 rounded-lg p-6 transition-all duration-300 ease-in-out">
                <h2 id="keywords-title" class="text-2xl font-bold mb-4 text-slate-700 text-center">Keywords</h2>
                <div id="keywords-container" class="space-y-4">
                    <!-- Keywords will be injected by JavaScript -->
                </div>
            </div>

            <!-- Recording and Evaluation Section -->
            <div class="space-y-6">
                <div class="bg-slate-100 rounded-lg p-6 flex flex-col items-center justify-center space-y-4">
                    <div id="status" class="text-xl font-medium text-slate-600">Press "Start" to begin</div>
                     <div id="recording-controls" class="flex flex-col items-center justify-center space-y-4 w-full transition-all duration-300">
                        <div id="timer" class="text-5xl font-bold text-sky-600">2:00</div>
                        <button id="record-btn" class="px-10 py-4 bg-sky-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-sky-700 transition-all duration-300 w-48 text-center">
                            Start
                        </button>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="result-container" class="hidden bg-white border border-slate-200 rounded-lg p-6 space-y-4">
                    <h2 class="text-2xl font-bold text-slate-700">Evaluation Result</h2>
                    <div class="text-center">
                        <p class="text-lg text-slate-500">Your Score</p>
                        <p id="score" class="text-7xl font-bold text-sky-600">0</p>
                    </div>
                    <div>
                        <p class="font-bold text-slate-600 text-lg">Feedback:</p>
                        <p id="feedback" class="text-slate-600 bg-slate-50 p-3 rounded-md text-lg"></p>
                    </div>
                     <div>
                        <p class="font-bold text-slate-600 text-lg mb-2">Listen to your recording:</p>
                        <audio id="audio-player" controls class="w-full"></audio>
                    </div>
                    <div>
                        <p class="font-bold text-slate-600 text-lg">Recognized Text:</p>
                        <div id="transcript-container" class="text-slate-600 bg-slate-50 p-3 rounded-md border border-slate-200">
                           <p id="transcript" class="text-lg"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // DOM Elements
        const recordBtn = document.getElementById('record-btn');
        const statusEl = document.getElementById('status');
        const timerEl = document.getElementById('timer');
        const keywordsContainer = document.getElementById('keywords-container');
        const keywordsSection = document.getElementById('keywords-section');
        const keywordsTitle = document.getElementById('keywords-title');
        const resultContainer = document.getElementById('result-container');
        const scoreEl = document.getElementById('score');
        const feedbackEl = document.getElementById('feedback');
        const audioPlayer = document.getElementById('audio-player');
        const transcriptEl = document.getElementById('transcript');
        const modeFullBtn = document.getElementById('mode-full');
        const modeParagraphBtn = document.getElementById('mode-paragraph');
        const paragraphSelectionContainer = document.getElementById('paragraph-selection');
        const timeSlider = document.getElementById('time-slider');
        const timeDisplay = document.getElementById('time-display');
        const overlay = document.getElementById('overlay');
        const recordingControls = document.getElementById('recording-controls');


        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'en-US';
            recognition.interimResults = true;
        } else {
            statusEl.textContent = "Sorry, your browser doesn't support Speech Recognition.";
            recordBtn.disabled = true;
        }
        
        // Media Recorder Setup
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        
        // App State
        let isRecording = false;
        let timerId;
        let currentMode = 'full'; // 'full' or 'paragraph'
        let currentParagraphIndex = 0; // 0-3
        const DEFAULT_FULL_SECONDS = 120;
        const DEFAULT_PARAGRAPH_SECONDS = 45;
        let secondsForTimer;
        let finalTranscript = '';
        let interimTranscript = '';

        // Keywords Data
        const keywordGroups = [
            ["the first person", "to go to", "studied law", "The only black student", "suffered", "the racist policies of the apartheid", "more famous", "a regional president", "opened", "defended", "was put into jail", "continued fighting"],
            ["At first", "a damp cell at Robben Island Prison", "at a limestone mine", "his eyes", "However", "at night", "Later", "Pollsmoor prison, where", "were better", "was allowed to build", "At last", "released", "1990"],
            ["Following the fall", "free elections", "1994", "President", "was divided", "moved towards a multi-racial democracy", "South Africa's national team", "at the 1995 Rugby World Cup", "appeared", "wearing", "united", "the Rainbow Nation"],
            ["1999", "stepped down", "received", "including", "1993", "A giant statue", "where", "was released", "died", "2013"]
        ];
        const allKeywords = keywordGroups.flat();

        function createKeywordTag(keyword) {
            const tag = document.createElement('span');
            tag.textContent = keyword;
            tag.className = 'keyword-tag';
            tag.id = `kw-${keyword.replace(/\s+/g, '-')}`;
            return tag;
        }

        function updateTimerDisplayFromSlider() {
            const seconds = parseInt(timeSlider.value);
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            const formattedTime = `${min}:${sec < 10 ? '0' : ''}${sec}`;
            timeDisplay.textContent = formattedTime;
            if (!isRecording) {
                timerEl.textContent = formattedTime;
            }
        }

        function setupPracticeArea() {
            if (isRecording) stopRecording();
            stopTimer();
            resultContainer.classList.add('hidden');
            recordBtn.disabled = false;
            statusEl.textContent = 'Press "Start" to begin';
            keywordsContainer.innerHTML = '';

            updateTimerDisplayFromSlider();

            if (currentMode === 'full') {
                keywordsTitle.textContent = 'Keywords (Full Text)';
                keywordGroups.forEach((group, index) => {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = index === 0 ? '' : 'border-t border-slate-300 pt-4';
                    const groupTitle = document.createElement('h3');
                    groupTitle.textContent = `Paragraph ${index + 1}`;
                    groupTitle.className = 'text-lg font-bold text-slate-600 mb-2 text-center';
                    groupContainer.appendChild(groupTitle);
                    const keywordsWrapper = document.createElement('div');
                    keywordsWrapper.className = 'flex flex-wrap justify-center';
                    group.forEach(keyword => keywordsWrapper.appendChild(createKeywordTag(keyword)));
                    groupContainer.appendChild(keywordsWrapper);
                    keywordsContainer.appendChild(groupContainer);
                });
            } else { // Paragraph mode
                keywordsTitle.textContent = `Keywords (Paragraph ${currentParagraphIndex + 1})`;
                const group = keywordGroups[currentParagraphIndex];
                const keywordsWrapper = document.createElement('div');
                keywordsWrapper.className = 'flex flex-wrap justify-center';
                group.forEach(keyword => keywordsWrapper.appendChild(createKeywordTag(keyword)));
                keywordsContainer.appendChild(keywordsWrapper);
            }
        }

        function setupParagraphButtons() {
            paragraphSelectionContainer.innerHTML = '';
            keywordGroups.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.textContent = `Paragraph ${index + 1}`;
                btn.className = 'px-4 py-2 font-bold rounded-full transition-colors duration-300';
                btn.dataset.index = index;
                btn.addEventListener('click', () => {
                    currentParagraphIndex = index;
                    setActiveParagraphButton();
                    setupPracticeArea();
                });
                paragraphSelectionContainer.appendChild(btn);
            });
        }
        
        function setActiveParagraphButton() {
            const buttons = paragraphSelectionContainer.querySelectorAll('button');
            buttons.forEach((btn, index) => {
                btn.classList.toggle('mode-btn-active', index === currentParagraphIndex);
                btn.classList.toggle('mode-btn-inactive', index !== currentParagraphIndex);
            });
        }
        
        modeFullBtn.addEventListener('click', () => {
            currentMode = 'full';
            modeFullBtn.classList.add('mode-btn-active');
            modeFullBtn.classList.remove('mode-btn-inactive');
            modeParagraphBtn.classList.remove('mode-btn-active');
            modeParagraphBtn.classList.add('mode-btn-inactive');
            paragraphSelectionContainer.classList.add('hidden');
            timeSlider.value = DEFAULT_FULL_SECONDS;
            setupPracticeArea();
        });

        modeParagraphBtn.addEventListener('click', () => {
            currentMode = 'paragraph';
            modeParagraphBtn.classList.add('mode-btn-active');
            modeParagraphBtn.classList.remove('mode-btn-inactive');
            modeFullBtn.classList.remove('mode-btn-active');
            modeFullBtn.classList.add('mode-btn-inactive');
            paragraphSelectionContainer.classList.remove('hidden');
            setupParagraphButtons();
            currentParagraphIndex = 0; // Reset to first paragraph
            setActiveParagraphButton();
            timeSlider.value = DEFAULT_PARAGRAPH_SECONDS;
            setupPracticeArea();
        });

        timeSlider.addEventListener('input', updateTimerDisplayFromSlider);

        function startTimer() {
            secondsForTimer = parseInt(timeSlider.value);
            timerId = setInterval(() => {
                secondsForTimer--;
                const min = Math.floor(secondsForTimer / 60);
                const sec = secondsForTimer % 60;
                timerEl.textContent = `${min}:${sec < 10 ? '0' : ''}${sec}`;
                if (secondsForTimer <= 0) {
                    stopRecording();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerId);
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                finalTranscript = '';
                interimTranscript = '';
                transcriptEl.parentElement.classList.remove('hidden');
                transcriptEl.textContent = 'Listening...';
                audioChunks = [];

                overlay.classList.add('show');
                keywordsSection.classList.add('zoomed');
                recordingControls.classList.add('active');


                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                mediaRecorder.addEventListener('dataavailable', e => audioChunks.push(e.data));
                mediaRecorder.addEventListener('stop', () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    audioPlayer.src = URL.createObjectURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                });
                
                recognition.start();
                
                statusEl.textContent = 'Recording... Speak now!';
                recordBtn.textContent = 'Stop';
                resultContainer.classList.add('hidden');
                startTimer();
            } catch (err) {
                console.error("Error accessing microphone:", err);
                statusEl.textContent = "Microphone access denied.";
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;

            overlay.classList.remove('show');
            keywordsSection.classList.remove('zoomed');
            recordingControls.classList.remove('active');

            
            mediaRecorder.stop();
            recognition.stop();
            statusEl.textContent = 'Evaluating... Please wait.';
            recordBtn.textContent = 'Start';
            recordBtn.disabled = true;
            stopTimer();
            updateTimerDisplayFromSlider();
        }

        recordBtn.addEventListener('click', () => {
            isRecording ? stopRecording() : startRecording();
        });
        
        recognition.onresult = (event) => {
            interimTranscript = '';
            let tempFinalTranscript = '';
            for (let i = 0; i < event.results.length; ++i) {
                const transcriptPart = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    tempFinalTranscript += transcriptPart + ' ';
                } else {
                    interimTranscript += transcriptPart;
                }
            }
            finalTranscript = tempFinalTranscript;
            transcriptEl.textContent = finalTranscript + interimTranscript;
        };
        
        recognition.onend = () => {
            if (!isRecording) {
                 evaluateSummary(finalTranscript);
                 recordBtn.disabled = false;
            }
        };

        function evaluateSummary(transcript) {
            statusEl.textContent = 'Evaluation complete!';
            transcriptEl.textContent = transcript.trim() || "No speech was detected.";

            if (!transcript.trim()) {
                scoreEl.textContent = "0";
                feedbackEl.textContent = "We couldn't hear anything. Please make sure your microphone is working and try again.";
                resultContainer.classList.remove('hidden');
                return;
            }

            const keywordsToEvaluate = (currentMode === 'full') ? allKeywords : keywordGroups[currentParagraphIndex];
            const lowerCaseTranscript = transcript.toLowerCase();
            let matchedKeywords = [];

            keywordsToEvaluate.forEach(keyword => {
                const lowerCaseKeyword = keyword.toLowerCase();
                if (lowerCaseTranscript.includes(lowerCaseKeyword)) {
                    matchedKeywords.push(keyword);
                    const tag = document.getElementById(`kw-${keyword.replace(/\s+/g, '-')}`);
                    if(tag) tag.classList.add('used-keyword');
                }
            });

            const baseScore = keywordsToEvaluate.length > 0 ? (matchedKeywords.length / keywordsToEvaluate.length) * 100 : 0;
            const finalScore = Math.min(100, Math.round(baseScore * 1.2 + 15));

            scoreEl.textContent = finalScore;
            
            let feedbackText = '';
            if (finalScore >= 90) {
                feedbackText = "Excellent! You've created a wonderful summary using the keywords. Your speaking is clear and well-structured.";
            } else if (finalScore >= 70) {
                feedbackText = "Great job! You've used many of the keywords well. Try to connect the ideas more smoothly next time.";
            } else if (finalScore >= 50) {
                feedbackText = "Good effort! You've got the main ideas. Focus on using more of the provided keywords to build your summary.";
            } else {
                feedbackText = "Keep practicing! Listen to your recording and the sample summary. Try to connect more keywords to tell the story.";
            }

            const unusedKeywords = keywordsToEvaluate.filter(k => !matchedKeywords.includes(k));
            if (unusedKeywords.length > 0 && finalScore < 95) {
                feedbackText += ` \nFor an even better summary, try including: "${unusedKeywords.slice(0, 2).join('", "')}".`;
            }

            feedbackEl.textContent = feedbackText;
            resultContainer.classList.remove('hidden');
        }

        // Initial setup
        window.onload = () => {
            modeFullBtn.click();
        };
    </script>
</body>
</html>